<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
   "http://www.w3.org/TR/html4/strict.dtd">
<HTML>
   <HEAD>
      <TITLE>My first HTML document</TITLE>
      <style rel="stylesheet" type="text/css">
body {
 font-size: 23px;
 margin-top: 50px;
    margin-bottom: 50px;
    margin-right: 80px;
    margin-left: 80px;
    padding-top: 50px;
    padding-bottom: 50px;
    padding-right: 80px;
    padding-left: 80px;
    line-height:35px;
}
</style>
      <script type="text/x-mathjax-config">
MathJax.Hub.Config({
    "HTML-CSS" : {
        availableFonts : ["STIX"],
        preferredFont : "STIX",
        webFont : "STIX-Web",
        imageFont : null
    }
});
</script>
     <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js" type="text/javascript">
    MathJax.Hub.Config({
        HTML: ["input/TeX","output/HTML-CSS"],
        TeX: { extensions: ["AMSmath.js","AMSsymbols.js"],
               equationNumbers: { autoNumber: "AMS" } },
        extensions: ["tex2jax.js"],
        jax: ["input/TeX","output/HTML-CSS"],
        tex2jax: { inlineMath: [ ['$$$','$$$'] ],
                   displayMath: [ ['$$$$','$$$$'] ],
                   processEscapes: true },
        "HTML-CSS": { availableFonts: ["TeX"],
                      linebreaks: { automatic: true } }
    });
</script>
   </HEAD>
   <BODY>
q_learing_with_q_network_with_policy_gradient_in_cartpole_environment.html
<xmp>
import numpy as np
# python 3.5
import _pickle as pickle 
import tensorflow as tf
# %matplotlib inline
import matplotlib.pyplot as plt
import math
import gym

env = gym.make('CartPole-v0')

# You try to use learing with random actions
env.reset()
random_episodes = 0
reward_sum = 0
while random_episodes < 10:
    env.render()
    observation, reward, done, _ = env.step(np.random.randint(0,2))
    reward_sum += reward
    if done:
        random_episodes += 1
        print ("Reward for this episode was:",reward_sum)
        reward_sum = 0
        env.reset()
# Reward for this episode was: 14.0
# Reward for this episode was: 15.0
# Reward for this episode was: 29.0
# Reward for this episode was: 23.0
# Reward for this episode was: 28.0
# Reward for this episode was: 14.0
# Reward for this episode was: 71.0
# Reward for this episode was: 11.0
# Reward for this episode was: 30.0
# Reward for this episode was: 42.0

H = 10
batch_size = 5
learning_rate = 1e-2
gamma = 0.99
D = 4

tf.reset_default_graph()

observations = tf.placeholder(tf.float32, [None,D] , name="input_x")
W1 = tf.get_variable("W1",shape=[D, H],initializer=tf.contrib.layers.xavier_initializer())
layer1 = tf.nn.relu(tf.matmul(observations,W1))

W2 = tf.get_variable("W2",shape=[H, 1],initializer=tf.contrib.layers.xavier_initializer())
score = tf.matmul(layer1,W2)
probability = tf.nn.sigmoid(score)

tvars = tf.trainable_variables()
input_y = tf.placeholder(tf.float32,[None,1], name="input_y")
advantages = tf.placeholder(tf.float32,name="reward_signal")

loglik = tf.log(input_y*(input_y - probability) + (1 - input_y)*(input_y + probability))
loss = -tf.reduce_mean(loglik * advantages)
newGrads = tf.gradients(loss,tvars)

adam = tf.train.AdamOptimizer(learning_rate=learning_rate) # 최적화기 adam
W1Grad = tf.placeholder(tf.float32,name="batch_grad1") # 그라디언트 저장하는 부분
W2Grad = tf.placeholder(tf.float32,name="batch_grad2")
batchGrad = [W1Grad,W2Grad]
updateGrads = adam.apply_gradients(zip(batchGrad,tvars))

def discount_rewards(r):
    discounted_r = np.zeros_like(r)
    running_add = 0
    for t in reversed(range(0, r.size)):
        running_add = running_add * gamma + r[t]
        discounted_r[t] = running_add
    return discounted_r

xs,drs,ys = [],[],[]
running_reward = None
reward_sum = 0
episode_number = 1
total_episodes = 10000
init = tf.global_variables_initializer()

with tf.Session() as sess:
    rendering = False
    sess.run(init)
    observation = env.reset()
    gradBuffer = sess.run(tvars)
    for ix,grad in enumerate(gradBuffer):
        gradBuffer[ix] = grad * 0
    while episode_number <= total_episodes:
        if reward_sum/batch_size > 100 or rendering == True : 
            env.render()
            rendering = True
        x = np.reshape(observation,[1,D])
        tfprob = sess.run(probability,feed_dict={observations: x})
        action = 1 if np.random.uniform() < tfprob else 0

        xs.append(x)
        y = 1 if action == 0 else 0
        ys.append(y)

        observation, reward, done, info = env.step(action)
        reward_sum += reward
        
        drs.append(reward) 
        
        if done: 
            episode_number += 1

            epx = np.vstack(xs)
            epy = np.vstack(ys)
            epr = np.vstack(drs)
            xs,drs,ys = [],[],[]

            discounted_epr = discount_rewards(epr)
            discounted_epr -= np.mean(discounted_epr)
            discounted_epr /= np.std(discounted_epr)

            tGrad = sess.run(newGrads,feed_dict={observations: epx, input_y: epy, advantages: discounted_epr})

            for ix,grad in enumerate(tGrad):
                gradBuffer[ix] += grad
                
            if episode_number % batch_size == 0: 
                sess.run(updateGrads,feed_dict={W1Grad: gradBuffer[0],W2Grad:gradBuffer[1]})
                for ix,grad in enumerate(gradBuffer):
                    gradBuffer[ix] = grad * 0
                
                running_reward = reward_sum if running_reward is None else running_reward * 0.99 + reward_sum * 0.01
                
                print ('Average reward for episode %f.  Total average reward %f.' % (reward_sum/batch_size, running_reward/batch_size))
                
                if reward_sum/batch_size > 200: 
                    print ("Task solved in",episode_number,'episodes!')
                    break
                
                reward_sum = 0
            observation = env.reset()
        
print (episode_number,'Episodes completed.')
# Average reward for episode 20.000000.  Total average reward 20.000000.
# Average reward for episode 17.400000.  Total average reward 19.974000.
# Average reward for episode 14.600000.  Total average reward 19.920260.
# Average reward for episode 20.600000.  Total average reward 19.927057.
# Average reward for episode 23.600000.  Total average reward 19.963787.
# Average reward for episode 26.600000.  Total average reward 20.030149.
# Average reward for episode 45.600000.  Total average reward 20.285847.
# Average reward for episode 24.200000.  Total average reward 20.324989.
# Average reward for episode 26.600000.  Total average reward 20.387739.
# Average reward for episode 27.200000.  Total average reward 20.455862.
# Average reward for episode 34.800000.  Total average reward 20.599303.
# Average reward for episode 23.800000.  Total average reward 20.631310.
# Average reward for episode 13.400000.  Total average reward 20.558997.
# Average reward for episode 28.800000.  Total average reward 20.641407.
# Average reward for episode 20.600000.  Total average reward 20.640993.
# Average reward for episode 38.800000.  Total average reward 20.822583.
# Average reward for episode 25.200000.  Total average reward 20.866357.
# Average reward for episode 16.000000.  Total average reward 20.817694.
# Average reward for episode 27.600000.  Total average reward 20.885517.
# Average reward for episode 38.000000.  Total average reward 21.056661.
# Average reward for episode 19.400000.  Total average reward 21.040095.
# Average reward for episode 27.800000.  Total average reward 21.107694.
# Average reward for episode 38.400000.  Total average reward 21.280617.
# Average reward for episode 32.600000.  Total average reward 21.393811.
# Average reward for episode 35.400000.  Total average reward 21.533873.
# Average reward for episode 35.200000.  Total average reward 21.670534.
# Average reward for episode 23.800000.  Total average reward 21.691829.
# Average reward for episode 34.800000.  Total average reward 21.822910.
# Average reward for episode 26.800000.  Total average reward 21.872681.
# Average reward for episode 25.800000.  Total average reward 21.911954.
# Average reward for episode 19.400000.  Total average reward 21.886835.
# Average reward for episode 26.000000.  Total average reward 21.927967.
# Average reward for episode 27.000000.  Total average reward 21.978687.
# Average reward for episode 42.600000.  Total average reward 22.184900.
# Average reward for episode 31.000000.  Total average reward 22.273051.
# Average reward for episode 25.000000.  Total average reward 22.300321.
# Average reward for episode 47.200000.  Total average reward 22.549317.
# Average reward for episode 18.600000.  Total average reward 22.509824.
# Average reward for episode 30.200000.  Total average reward 22.586726.
# Average reward for episode 20.800000.  Total average reward 22.568859.
# Average reward for episode 32.400000.  Total average reward 22.667170.
# Average reward for episode 37.000000.  Total average reward 22.810498.
# Average reward for episode 27.600000.  Total average reward 22.858393.
# Average reward for episode 22.000000.  Total average reward 22.849809.
# Average reward for episode 27.400000.  Total average reward 22.895311.
# Average reward for episode 28.400000.  Total average reward 22.950358.
# Average reward for episode 26.800000.  Total average reward 22.988855.
# Average reward for episode 26.400000.  Total average reward 23.022966.
# Average reward for episode 35.000000.  Total average reward 23.142736.
# Average reward for episode 36.200000.  Total average reward 23.273309.
# Average reward for episode 32.000000.  Total average reward 23.360576.
# Average reward for episode 26.200000.  Total average reward 23.388970.
# Average reward for episode 29.000000.  Total average reward 23.445081.
# Average reward for episode 22.800000.  Total average reward 23.438630.
# Average reward for episode 27.800000.  Total average reward 23.482243.
# Average reward for episode 27.200000.  Total average reward 23.519421.
# Average reward for episode 28.000000.  Total average reward 23.564227.
# Average reward for episode 35.200000.  Total average reward 23.680584.
# Average reward for episode 47.600000.  Total average reward 23.919779.
# Average reward for episode 32.000000.  Total average reward 24.000581.
# Average reward for episode 28.800000.  Total average reward 24.048575.
# Average reward for episode 19.200000.  Total average reward 24.000089.
# Average reward for episode 36.400000.  Total average reward 24.124088.
# Average reward for episode 36.600000.  Total average reward 24.248848.
# Average reward for episode 38.800000.  Total average reward 24.394359.
# Average reward for episode 34.800000.  Total average reward 24.498415.
# Average reward for episode 34.800000.  Total average reward 24.601431.
# Average reward for episode 51.000000.  Total average reward 24.865417.
# Average reward for episode 51.400000.  Total average reward 25.130763.
# Average reward for episode 27.200000.  Total average reward 25.151455.
# Average reward for episode 32.800000.  Total average reward 25.227941.
# Average reward for episode 52.000000.  Total average reward 25.495661.
# Average reward for episode 52.400000.  Total average reward 25.764705.
# Average reward for episode 70.800000.  Total average reward 26.215058.
# Average reward for episode 30.200000.  Total average reward 26.254907.
# Average reward for episode 37.000000.  Total average reward 26.362358.
# Average reward for episode 45.200000.  Total average reward 26.550734.
# Average reward for episode 40.400000.  Total average reward 26.689227.
# Average reward for episode 39.400000.  Total average reward 26.816335.
# Average reward for episode 31.200000.  Total average reward 26.860171.
# Average reward for episode 42.400000.  Total average reward 27.015570.
# Average reward for episode 38.800000.  Total average reward 27.133414.
# Average reward for episode 45.200000.  Total average reward 27.314080.
# Average reward for episode 76.800000.  Total average reward 27.808939.
# Average reward for episode 48.000000.  Total average reward 28.010850.
# Average reward for episode 55.400000.  Total average reward 28.284741.
# Average reward for episode 50.800000.  Total average reward 28.509894.
# Average reward for episode 48.800000.  Total average reward 28.712795.
# Average reward for episode 40.400000.  Total average reward 28.829667.
# Average reward for episode 40.000000.  Total average reward 28.941370.
# Average reward for episode 80.600000.  Total average reward 29.457956.
# Average reward for episode 52.400000.  Total average reward 29.687377.
# Average reward for episode 60.600000.  Total average reward 29.996503.
# Average reward for episode 41.400000.  Total average reward 30.110538.
# Average reward for episode 63.000000.  Total average reward 30.439433.
# Average reward for episode 83.400000.  Total average reward 30.969038.
# Average reward for episode 69.600000.  Total average reward 31.355348.
# Average reward for episode 48.200000.  Total average reward 31.523795.
# Average reward for episode 40.200000.  Total average reward 31.610557.
# Average reward for episode 60.000000.  Total average reward 31.894451.
# Average reward for episode 39.200000.  Total average reward 31.967507.
# Average reward for episode 53.400000.  Total average reward 32.181831.
# Average reward for episode 54.800000.  Total average reward 32.408013.
# Average reward for episode 40.400000.  Total average reward 32.487933.
# Average reward for episode 35.200000.  Total average reward 32.515054.
# Average reward for episode 40.000000.  Total average reward 32.589903.
# Average reward for episode 75.600000.  Total average reward 33.020004.
# Average reward for episode 65.600000.  Total average reward 33.345804.
# Average reward for episode 64.800000.  Total average reward 33.660346.
# Average reward for episode 51.400000.  Total average reward 33.837743.
# Average reward for episode 42.400000.  Total average reward 33.923365.
# Average reward for episode 72.800000.  Total average reward 34.312131.
# Average reward for episode 66.600000.  Total average reward 34.635010.
# Average reward for episode 85.200000.  Total average reward 35.140660.
# Average reward for episode 78.400000.  Total average reward 35.573253.
# Average reward for episode 90.800000.  Total average reward 36.125521.
# Average reward for episode 83.800000.  Total average reward 36.602266.
# Average reward for episode 71.000000.  Total average reward 36.946243.
# Average reward for episode 65.400000.  Total average reward 37.230781.
# Average reward for episode 65.400000.  Total average reward 37.512473.
# Average reward for episode 65.200000.  Total average reward 37.789348.
# Average reward for episode 72.000000.  Total average reward 38.131455.
# Average reward for episode 83.600000.  Total average reward 38.586140.
# Average reward for episode 92.600000.  Total average reward 39.126279.
# Average reward for episode 71.000000.  Total average reward 39.445016.
# Average reward for episode 94.400000.  Total average reward 39.994566.
# Average reward for episode 114.600000.  Total average reward 40.740620.
# Average reward for episode 122.200000.  Total average reward 41.555214.
# Average reward for episode 129.400000.  Total average reward 42.433662.
# Average reward for episode 51.200000.  Total average reward 42.521325.
# Average reward for episode 131.400000.  Total average reward 43.410112.
# Average reward for episode 124.600000.  Total average reward 44.222011.
# Average reward for episode 113.400000.  Total average reward 44.913791.
# Average reward for episode 140.800000.  Total average reward 45.872653.
# Average reward for episode 128.000000.  Total average reward 46.693926.
# Average reward for episode 89.600000.  Total average reward 47.122987.
# Average reward for episode 108.800000.  Total average reward 47.739757.
# Average reward for episode 74.800000.  Total average reward 48.010360.
# Average reward for episode 142.000000.  Total average reward 48.950256.
# Average reward for episode 138.800000.  Total average reward 49.848753.
# Average reward for episode 137.000000.  Total average reward 50.720266.
# Average reward for episode 127.000000.  Total average reward 51.483063.
# Average reward for episode 138.800000.  Total average reward 52.356233.
# Average reward for episode 160.000000.  Total average reward 53.432670.
# Average reward for episode 120.600000.  Total average reward 54.104344.
# Average reward for episode 229.400000.  Total average reward 55.857300.
# Task solved in 730 episodes!
# 730 Episodes completed.
</xmp>
   </BODY>
</HTML>
